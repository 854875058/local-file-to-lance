# DataVerse Pro 多模态数据中台 - 系统架构

## 1. 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DataVerse Pro 多模态数据中台                          │
│                        (Streamlit Web Application)                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
        ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
        │   数据接入层      │ │  检索服务层   │ │   监控诊断层      │
        │  (ETL Module)    │ │ (Search API) │ │ (Stats & Diag)   │
        └──────────────────┘ └──────────────┘ └──────────────────┘
                │                     │                  │
                └─────────────────────┼──────────────────┘
                                      ▼
        ┌─────────────────────────────────────────────────────────┐
        │                    AI 模型引擎层                          │
        │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐   │
        │  │ BGE-Small-ZH │ │ CLIP-ViT-B32 │ │ Whisper-Base │   │
        │  │  (文本向量)   │ │  (图像向量)   │ │  (语音转文本) │   │
        │  └──────────────┘ └──────────────┘ └──────────────┘   │
        └─────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
        ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
        │   LanceDB 向量库  │ │  SQLite 元数据│ │  SeaweedFS 对象存储│
        │  (S3 存储后端)    │ │  (本地数据库) │ │   (S3 兼容接口)   │
        └──────────────────┘ └──────────────┘ └──────────────────┘
```

## 2. 数据流架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据接入流程                                      │
└─────────────────────────────────────────────────────────────────────────────┘

用户上传文件
    │
    ├─→ 本地上传 (Streamlit File Uploader)
    └─→ SFTP 采集 (Paramiko)
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ETL 处理管道 (etl.py)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. 文件哈希计算 (MD5)                                                        │
│     └─→ 去重检查 (SQLite file_registry)                                      │
│                                                                              │
│  2. 文件上传到 S3                                                             │
│     └─→ SeaweedFS (raw_bucket)                                              │
│     └─→ 路径: raw/{date}/{category}/{uuid}_{filename}                       │
│                                                                              │
│  3. 内容提取 (extract_content)                                               │
│     ├─→ 文本类: txt, md, docx, pdf, pptx, csv, xlsx                         │
│     ├─→ 图像类: jpg, png, gif, bmp, webp                                    │
│     ├─→ 音视频: mp3, wav, mp4, avi (Whisper 转录)                           │
│     └─→ 压缩包: zip, tar, gz (递归解压处理)                                   │
│                                                                              │
│  4. 向量化处理                                                                │
│     ├─→ 文本: BGE-Small-ZH (512维)                                          │
│     │   └─→ 分块: RecursiveCharacterTextSplitter (500/50)                  │
│     ├─→ 图像: CLIP-ViT-B32 (512维)                                          │
│     └─→ PDF: 文本提取 + 页面图像向量化                                        │
│                                                                              │
│  5. 数据持久化                                                                │
│     ├─→ LanceDB files 表: 原始文件 bytes + 全文                              │
│     ├─→ LanceDB text_chunks 表: 文本向量 + 切片                              │
│     ├─→ LanceDB image_chunks 表: 图像向量                                    │
│     └─→ SQLite file_registry: 文件元数据                                     │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          检索与预览流程                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. 用户输入查询                                                              │
│     └─→ 文本查询 / 图像查询                                                   │
│                                                                              │
│  2. 向量检索                                                                  │
│     ├─→ 文本模式: text_chunks 表 (BGE 向量相似度)                            │
│     └─→ 图像模式: image_chunks 表 (CLIP 向量相似度)                          │
│                                                                              │
│  3. 结果关联                                                                  │
│     └─→ 通过 file_hash 关联 files 表                                         │
│                                                                              │
│  4. 内容预览                                                                  │
│     ├─→ 图像: 直接显示 (st.image)                                            │
│     ├─→ 音视频: 播放器 (st.audio / st.video)                                 │
│     ├─→ 文档: 全文高亮显示 (text_full 字段)                                   │
│     └─→ 下载: 原始文件 bytes (st.download_button)                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. 存储架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            存储层架构                                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                      SeaweedFS (S3 兼容对象存储)                           │
│  Endpoint: http://192.168.20.4:8333                                      │
├──────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │   raw_bucket            │  │   lance_bucket                      │  │
│  │  (原始文件存储)          │  │  (LanceDB 数据文件)                  │  │
│  ├─────────────────────────┤  ├─────────────────────────────────────┤  │
│  │ raw/                    │  │ lance_lake/                         │  │
│  │  ├─ 2026/02/06/         │  │  ├─ text_chunks.lance               │  │
│  │  │  ├─ text/            │  │  ├─ image_chunks.lance              │  │
│  │  │  ├─ image/           │  │  ├─ files.lance                     │  │
│  │  │  ├─ audio/           │  │  └─ file_entities.lance             │  │
│  │  │  ├─ video/           │  │                                     │  │
│  │  │  └─ other/           │  │                                     │  │
│  └─────────────────────────┘  └─────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                      LanceDB 向量数据库                                    │
│  URI: s3://lance_bucket/lance_lake                                      │
├──────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ text_chunks 表 (文本向量检索)                                     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ - id: string (UUID)                                             │   │
│  │ - vector: float[512] (BGE 向量)                                 │   │
│  │ - text: string (文本切片)                                        │   │
│  │ - source_uri: string (S3 路径)                                  │   │
│  │ - doc_name: string (文件名)                                     │   │
│  │ - doc_type: string (文件类型)                                   │   │
│  │ - file_hash: string (MD5, 关联 files 表)                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ image_chunks 表 (图像向量检索)                                    │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ - id: string (UUID)                                             │   │
│  │ - vector: float[512] (CLIP 向量)                                │   │
│  │ - source_uri: string (S3 路径)                                  │   │
│  │ - doc_name: string (文件名)                                     │   │
│  │ - meta_info: string (元信息)                                    │   │
│  │ - file_hash: string (MD5, 关联 files 表)                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ files 表 (原始文件存储)                                           │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ - file_hash: string (MD5, 主键)                                 │   │
│  │ - doc_name: string (文件名)                                     │   │
│  │ - doc_type: string (文件类型)                                   │   │
│  │ - source_uri: string (S3 路径)                                  │   │
│  │ - file_bytes: binary (原始文件内容, <100MB)                     │   │
│  │ - text_full: string (全文文本, 用于预览高亮)                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ file_entities 表 (知识图谱, 试验版)                              │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ - file_hash: string                                             │   │
│  │ - entity: string (实体名称)                                     │   │
│  │ - entity_type: string (实体类型)                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                      SQLite 本地数据库                                     │
│  Path: ./user_data.db                                                   │
├──────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ file_registry 表 (文件注册与去重)                                 │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ - id: integer (主键)                                             │   │
│  │ - file_hash: string (MD5, 唯一索引)                             │   │
│  │ - file_name: string                                             │   │
│  │ - file_size: integer                                            │   │
│  │ - upload_time: timestamp                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ task_stats 表 (任务统计)                                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ - id: integer (主键)                                             │   │
│  │ - user_id: integer                                              │   │
│  │ - task_type: string                                             │   │
│  │ - file_count: integer                                           │   │
│  │ - success_count: integer                                        │   │
│  │ - processing_time: float                                        │   │
│  │ - created_at: timestamp                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────────┘
```

## 4. 模块架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          应用层 (app.py)                                      │
│                      Streamlit Web Application                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐      │
│  │ 数据资产看板  │ │  数据接入    │ │  智能检索    │ │  任务监控    │      │
│  │ (Dashboard)  │ │  (Ingest)   │ │  (Search)   │ │  (Monitor)  │      │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘      │
│  ┌──────────────┐ ┌──────────────┐                                         │
│  │ 对象存储浏览  │ │  数据诊断    │                                         │
│  │ (S3 Browser) │ │  (Diagnose) │                                         │
│  └──────────────┘ └──────────────┘                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
        ┌─────────────────────────────┼─────────────────────────────┐
        ▼                             ▼                             ▼
┌──────────────────┐       ┌──────────────────┐         ┌──────────────────┐
│   etl.py         │       │ models_loader.py │         │ database.py      │
│  (ETL 处理)      │       │  (AI 模型管理)    │         │ (元数据管理)      │
├──────────────────┤       ├──────────────────┤         ├──────────────────┤
│ - extract_content│       │ - load_models    │         │ - init_db        │
│ - process_pipeline│      │ - get_text_splitter│       │ - calculate_hash │
│ - batch_process  │       │ - get_lancedb_tables│      │ - check_exists   │
│ - sftp_task      │       │ - get_file_entities│       │ - register_file  │
│ - get_s3_client  │       │                  │         │ - get_task_stats │
└──────────────────┘       └──────────────────┘         └──────────────────┘
        │                             │                             │
        ▼                             ▼                             ▼
┌──────────────────┐       ┌──────────────────┐         ┌──────────────────┐
│ stats_service.py │       │   config.py      │         │  ui/styles.py    │
│  (统计服务)      │       │  (全局配置)       │         │  (UI 样式)       │
├──────────────────┤       ├──────────────────┤         ├──────────────────┤
│ - get_dashboard_stats│   │ - S3_CONFIG      │         │ - DASHBOARD_CSS  │
│ - get_task_trend │       │ - LANCE_DB_URI   │         │ - render_metric_card│
└──────────────────┘       │ - DEEPSEEK_API_KEY│        └──────────────────┘
                           │ - CHUNK_SIZE     │
                           │ - MAX_FILE_SIZE  │
                           └──────────────────┘
```

## 5. 技术栈总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              技术栈                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  前端框架:    Streamlit (Python Web UI)                                      │
│  AI 模型:     - sentence-transformers (BGE, CLIP)                           │
│              - OpenAI Whisper (语音转文本)                                   │
│  向量数据库:  LanceDB (S3 后端)                                               │
│  对象存储:    SeaweedFS (S3 兼容)                                             │
│  元数据库:    SQLite                                                          │
│  文档处理:    - python-docx (Word)                                           │
│              - pypdf (PDF)                                                   │
│              - python-pptx (PowerPoint)                                      │
│              - pandas (Excel, CSV)                                           │
│              - pdf2image (PDF 图像提取)                                       │
│  文本处理:    LangChain (RecursiveCharacterTextSplitter)                     │
│  远程采集:    Paramiko (SFTP)                                                │
│  对象存储SDK: boto3 (S3 客户端)                                               │
│  并发处理:    ThreadPoolExecutor                                             │
│  系统监控:    psutil                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 6. 部署架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          部署架构 (单机版)                                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                      应用服务器 (本地/云主机)                               │
├──────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  Streamlit App (Port: 8501)                                        │ │
│  │  - app.py (主应用)                                                  │ │
│  │  - 启动脚本: start.sh / restart.sh / stop.sh                       │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  AI 模型缓存 (本地磁盘)                                             │ │
│  │  - ~/.cache/huggingface/                                           │ │
│  │  - ~/.cache/whisper/                                               │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  临时文件目录                                                        │ │
│  │  - temp_uploads/ (上传临时文件)                                     │ │
│  │  - temp_extracted/ (解压临时文件)                                   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  SQLite 数据库                                                       │ │
│  │  - user_data.db (元数据)                                            │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP/S3 API
                                ▼
┌──────────────────────────────────────────────────────────────────────────┐
│              SeaweedFS 服务器 (192.168.20.4:8333)                        │
├──────────────────────────────────────────────────────────────────────────┤
│  - S3 兼容接口                                                            │
│  - 原始文件存储 (raw_bucket)                                              │
│  - LanceDB 数据文件 (lance_bucket)                                        │
└──────────────────────────────────────────────────────────────────────────┘
```

## 7. 核心流程时序图

### 7.1 文件上传流程

```
用户          Streamlit UI      ETL Pipeline      AI Models      LanceDB       SeaweedFS
 │                │                  │                │             │              │
 │  上传文件      │                  │                │             │              │
 ├──────────────>│                  │                │             │              │
 │                │  batch_process   │                │             │              │
 │                ├─────────────────>│                │             │              │
 │                │                  │  计算 MD5      │             │              │
 │                │                  │  检查去重      │             │              │
 │                │                  ├───────────────────────────────────────────>│
 │                │                  │  上传原始文件  │             │              │
 │                │                  │<───────────────────────────────────────────│
 │                │                  │  提取内容      │             │              │
 │                │                  ├───────────────>│             │              │
 │                │                  │  向量化        │             │              │
 │                │                  │<───────────────│             │              │
 │                │                  ├────────────────────────────>│              │
 │                │                  │  写入 files 表 │             │              │
 │                │                  │<────────────────────────────│              │
 │                │                  ├────────────────────────────>│              │
 │                │                  │  写入 text/image_chunks     │              │
 │                │                  │<────────────────────────────│              │
 │                │  返回结果        │                │             │              │
 │                │<─────────────────│                │             │              │
 │  显示成功      │                  │                │             │              │
 │<───────────────│                  │                │             │              │
```

### 7.2 检索流程

```
用户          Streamlit UI      AI Models      LanceDB       files 表
 │                │                  │             │              │
 │  输入查询      │                  │             │              │
 ├──────────────>│                  │             │              │
 │                │  向量化查询      │             │              │
 │                ├─────────────────>│             │              │
 │                │<─────────────────│             │              │
 │                │  向量检索        │             │              │
 │                ├────────────────────────────────>│              │
 │                │  返回结果 (含 file_hash)        │              │
 │                │<────────────────────────────────│              │
 │                │  查询原始文件    │             │              │
 │                ├──────────────────────────────────────────────>│
 │                │  返回 file_bytes + text_full    │              │
 │                │<──────────────────────────────────────────────│
 │                │  渲染预览        │             │              │
 │  显示结果      │  (高亮/播放器)   │             │              │
 │<───────────────│                  │             │              │
```

---

## 📝 架构特点总结

### 优势
1. **多模态支持**: 统一处理文本、图像、音视频
2. **向量检索**: 基于语义的智能检索
3. **分布式存储**: S3 兼容的对象存储 + 向量数据库
4. **去重机制**: 基于 MD5 的文件去重
5. **整文件预览**: 支持原始文件下载和全文高亮
6. **监控诊断**: 完善的任务统计和数据一致性检查

### 当前限制
1. **单机部署**: 未实现分布式处理
2. **无用户系统**: 缺少权限管理
3. **同步处理**: 大文件处理可能阻塞
4. **内存限制**: 大文件 (>100MB) 不存储到 files 表
5. **知识图谱**: 仅为试验版，功能有限
